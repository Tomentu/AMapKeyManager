<!DOCTYPE html>
<html>
<head>
    <title>API Key 管理</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>API Key 管理</h2>
        
        <!-- 添加新key -->
        <div class="card mb-4">
            <div class="card-header">添加新 Key</div>
            <div class="card-body">
                <form id="addKeyForm">
                    <div class="mb-3">
                        <label class="form-label">Key</label>
                        <input type="text" class="form-control" name="key" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">描述</label>
                        <input type="text" class="form-control" name="description">
                    </div>
                    <button type="submit" class="btn btn-primary">添加</button>
                </form>
            </div>
        </div>
        
        <!-- key列表 -->
        <div class="card">
            <div class="card-header">Key 列表</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Key</th>
                                <th>描述</th>
                                <th>状态</th>
                                <th>关键字搜索</th>
                                <th>周边搜索</th>
                                <th>多边形搜索</th>
                                <th>最后重置</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="keyList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 格式化使用量显示
        function formatUsage(usage) {
            if (!usage) return '0 / 100';
            return `${usage.used} / ${usage.limit}<br>QPS: ${usage.qps}`;
        }

        // 加载key列表
        function loadKeys() {
            fetch('/admin/keys')
                .then(response => response.json())
                .then(keys => {
                    const tbody = document.getElementById('keyList');
                    tbody.innerHTML = '';
                    keys.forEach(key => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${key.key}</td>
                                <td>
                                    <input type="text" class="form-control form-control-sm"
                                        value="${key.description || ''}"
                                        onchange="updateKey(${key.id}, 'description', this.value)">
                                </td>
                                <td>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" 
                                               ${key.is_active ? 'checked' : ''}
                                               onchange="updateKey(${key.id}, 'is_active', this.checked)">
                                    </div>
                                </td>
                                <td>
                                    <small>${formatUsage(key.search_usage.keyword)}</small>
                                </td>
                                <td>
                                    <small>${formatUsage(key.search_usage.around)}</small>
                                </td>
                                <td>
                                    <small>${formatUsage(key.search_usage.polygon)}</small>
                                </td>
                                <td>
                                    <small>${key.last_reset ? new Date(key.last_reset).toLocaleString() : '-'}</small>
                                </td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="deleteKey(${key.id})">删除</button>
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Failed to load keys:', error);
                });
        }

        // 添加新key
        document.getElementById('addKeyForm').onsubmit = function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            fetch('/admin/keys', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(Object.fromEntries(formData))
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('添加失败: ' + data.error);
                } else {
                    loadKeys();
                    e.target.reset();
                }
            })
            .catch(error => {
                alert('添加失败: ' + error);
            });
        };

        // 更新key
        function updateKey(id, field, value) {
            fetch(`/admin/keys/${id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    [field]: value
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('更新失败: ' + data.error);
                } else {
                    loadKeys();
                }
            })
            .catch(error => {
                alert('更新失败: ' + error);
            });
        }

        // 删除key
        function deleteKey(id) {
            if (confirm('确定要删除这个key吗？')) {
                fetch(`/admin/keys/${id}`, {
                    method: 'DELETE'
                })
                .then(() => loadKeys());
            }
        }

        // 初始加载
        loadKeys();
    </script>
</body>
</html> 