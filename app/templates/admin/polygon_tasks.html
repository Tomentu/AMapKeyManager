<!DOCTYPE html>
<html>
<head>
    <title>多边形POI任务管理</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .progress-details {
            min-width: 300px;
            max-width: 400px;
        }
        .progress {
            background-color: #e9ecef;
        }
        .progress-bar {
            background-color: #007bff;
        }
        .table td {
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h2>多边形POI任务管理</h2>
        
        <!-- 创建新任务 -->
        <div class="card mb-4">
            <div class="card-header">创建新任务</div>
            <div class="card-body">
                <form id="createTaskForm">
                    <div class="mb-3">
                        <label class="form-label">任务ID</label>
                        <input type="text" class="form-control" name="task_id" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">任务名称</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">多边形坐标</label>
                        <textarea class="form-control" name="polygon" rows="3" required 
                                placeholder="格式：lng1,lat1|lng2,lat2|..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">创建任务</button>
                </form>
            </div>
        </div>
        
        <!-- 任务列表 -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>任务列表</span>
                <button class="btn btn-secondary btn-sm" onclick="loadTasks()">刷新</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>任务ID</th>
                                <th>名称</th>
                                <th>状态</th>
                                <th>进度详情</th>
                                <th>创建时间</th>
                                <th>更新时间</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="taskList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加Modal -->
    <div class="modal fade" id="progressModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-dialog-scrollable modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">任务进度详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="progressModalBody">
                </div>
            </div>
        </div>
    </div>

    <script>
        // 格式化状态显示
        function getStatusBadge(status) {
            const badges = {
                'pending': 'bg-secondary',
                'running': 'bg-primary',
                'completed': 'bg-success',
                'failed': 'bg-danger'
            };
            return `<span class="badge ${badges[status] || 'bg-secondary'}">${status}</span>`;
        }

        // 格式化进度显示（简略版，用于表格）
        function formatProgress(progress) {
            if (!progress || Object.keys(progress).length === 0) {
                return '<span class="text-muted">-</span>';
            }

            let html = '<div class="progress-details">';
            // 只显示当前进行中的类型
            const currentType = Object.entries(progress).find(([_, data]) => 
                data.processed_pages < data.total_pages
            );
            
            if (currentType) {
                const [type, data] = currentType;
                const percent = data.total_pages > 0 
                    ? Math.round(data.processed_pages / data.total_pages * 100) 
                    : 0;
                    
                html += `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <small>${type}</small>
                            <small>${data.processed_pages}/${data.total_pages}页 
                                   (${data.processed_count}/${data.total_count}条)</small>
                        </div>
                        <div class="progress" style="height: 5px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: ${percent}%;" 
                                 aria-valuenow="${percent}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // 添加查看详情按钮
            const completedCount = Object.values(progress).filter(data => 
                data.processed_pages === data.total_pages
            ).length;
            
            if (completedCount > 0) {
                html += `
                    <button class="btn btn-sm btn-outline-info mt-2" 
                            onclick='showProgressDetails(${JSON.stringify(progress)})'>
                        查看已完成(${completedCount})
                    </button>
                `;
            }
            
            html += '</div>';
            return html;
        }

        // 加载任务列表
        function loadTasks() {
            fetch('/api/polygon/tasks')
                .then(response => response.json())
                .then(tasks => {
                    const tbody = document.getElementById('taskList');
                    tbody.innerHTML = '';
                    tasks.forEach(task => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${task.task_id}</td>
                                <td>${task.name}</td>
                                <td>${getStatusBadge(task.status)}</td>
                                <td>${formatProgress(task.progress)}</td>
                                <td><small>${new Date(task.created_at).toLocaleString()}</small></td>
                                <td><small>${new Date(task.updated_at).toLocaleString()}</small></td>
                                <td>
                                    ${task.status === 'failed' || task.status === 'pending' ? 
                                        `<button class="btn btn-warning btn-sm" onclick="resumeTask('${task.task_id}')">恢复</button>` : ''}
                                    ${task.status === 'completed' ? 
                                        `<button class="btn btn-success btn-sm" onclick="downloadResult('${task.task_id}')">下载</button>` : ''}
                                </td>
                            </tr>
                        `;
                    });
                })
                .catch(error => {
                    console.error('Failed to load tasks:', error);
                    alert('加载任务列表失败');
                });
        }

        // 创建新任务
        document.getElementById('createTaskForm').onsubmit = function(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            fetch('/api/polygon/tasks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(Object.fromEntries(formData))
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert('创建失败: ' + data.error);
                } else {
                    loadTasks();
                    e.target.reset();
                }
            })
            .catch(error => {
                alert('创建失败: ' + error);
            });
        };

        // 恢复任务
        function resumeTask(taskId) {
            if (confirm('确定要恢复这个任务吗？')) {
                fetch(`/api/polygon/tasks/${taskId}/resume`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('恢复失败: ' + data.error);
                    } else {
                        loadTasks();
                    }
                })
                .catch(error => {
                    alert('恢复失败: ' + error);
                });
            }
        }

        // 下载结果
        function downloadResult(taskId) {
            window.open(`/api/polygon/tasks/${taskId}/result`);
        }

        // 自动刷新（每30秒）
        setInterval(loadTasks, 30000);

        // 初始加载
        loadTasks();

        // 显示进度详情弹窗
        function showProgressDetails(progress) {
            const modalBody = document.getElementById('progressModalBody');
            let html = '<div class="progress-details">';
            
            // 已完成的类型
            const completedTypes = Object.entries(progress)
                .filter(([_, data]) => data.processed_pages === data.total_pages);
                
            if (completedTypes.length > 0) {
                html += '<h6 class="mb-3">已完成的类型：</h6>';
                completedTypes.forEach(([type, data]) => {
                    html += `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-success">${type}</span>
                                <span class="badge bg-success">已完成</span>
                            </div>
                            <small class="text-muted">
                                共 ${data.total_pages} 页，${data.total_count} 条数据
                            </small>
                        </div>
                    `;
                });
            }
                
            // 进行中的类型
            const inProgress = Object.entries(progress)
                .filter(([_, data]) => data.processed_pages < data.total_pages);
                
            if (inProgress.length > 0) {
                html += '<h6 class="mb-3 mt-4">进行中的类型：</h6>';
                inProgress.forEach(([type, data]) => {
                    const percent = Math.round(data.processed_pages / data.total_pages * 100);
                    html += `
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${type}</span>
                                <small>${percent}%</small>
                            </div>
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" role="progressbar" 
                                     style="width: ${percent}%;" 
                                     aria-valuenow="${percent}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                </div>
                            </div>
                            <small class="text-muted">
                                ${data.processed_pages}/${data.total_pages} 页，
                                ${data.processed_count}/${data.total_count} 条数据
                            </small>
                        </div>
                    `;
                });
            }
            
            // 添加总计信息
            const totalPages = Object.values(progress).reduce((sum, data) => sum + data.total_pages, 0);
            const processedPages = Object.values(progress).reduce((sum, data) => sum + data.processed_pages, 0);
            const totalCount = Object.values(progress).reduce((sum, data) => sum + data.total_count, 0);
            const processedCount = Object.values(progress).reduce((sum, data) => sum + data.processed_count, 0);
            
            html += `
                <div class="mt-4 pt-3 border-top">
                    <h6 class="mb-3">总计：</h6>
                    <div class="d-flex justify-content-between text-muted">
                        <small>总页数：${processedPages}/${totalPages}</small>
                        <small>总数据：${processedCount}/${totalCount}</small>
                    </div>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar" role="progressbar" 
                             style="width: ${Math.round(processedPages/totalPages*100)}%;">
                        </div>
                    </div>
                </div>
            `;
            
            html += '</div>';
            modalBody.innerHTML = html;
            
            const modal = new bootstrap.Modal(document.getElementById('progressModal'));
            modal.show();
        }
    </script>
</body>
</html> 